
@{
    ViewBag.Title = "EditDefinition";
    Layout = "~/Areas/Admin/Views/Shared/View_gooflowlayout.cshtml";
    string id = ViewBag.Id;
    string pageId = ViewBag.pageId;
}

<script type="text/javascript">

    $(document).ready(function () {
        var ifr = $("#@(pageId)WorkFlowDefBox");
        var property = {
            width: ifr.width(),
            height: ifr.height(),
            toolBtns: ["start", "end", "task", "node", "chat", "state", "plug", "join", "fork", "complex"],
            haveHead: true,
            headBtns: ["save", "undo", "redo", "reload"],//如果haveHead=true，则定义HEAD区的按钮
            haveTool: true,
            haveGroup: true,
            useOperStack: true
        };
        var remark = {
            cursor: "选择指针",
            direct: "转换连线",
            start: "开始结点",
            end: "结束结点",
            task: "任务结点",
            node: "自动结点",
            chat: "决策结点",
            state: "状态结点",
            plug: "附加插件",
            fork: "分支结点",
            join: "联合结点",
            complex: "复合结点",
            group: "组织划分框编辑开关"
        };
        var WorkFlowDef;


        WorkFlowDef = $.createGooFlow($("#@(pageId)WorkFlowDef"), property);
        WorkFlowDef.setNodeRemarks(remark);
        WorkFlowDef.onFreshClick = function () {
            loadData();
        }
        WorkFlowDef.onBtnSaveClick = function () {
            console.log("保存");

            var request = {
                Id: "@id",
                nodes: [],
                lines: [],
                areas: []
            };
            var units = WorkFlowDef.exportData();
            //转换为数组
            $.each(units.lines, function (i, n) {
                n.Id = i;
                request.lines.push(n)
            });
            $.each(units.areas, function (i, n) {
                n.Id = i;
                request.areas.push(n)
            });
            $.each(units.nodes, function (i, n) {
                n.Id = i;
                request.nodes.push(n)
            });
            console.log("提交请求");
            console.log(request);
            $.post("/api/WorkFlowDefinition/EditWorkFlowDefUnits", request, function (json) {
                showmsg(json);
                if (json.Message == 0) {
                    setData(json);
                }
            });
        }

        function setData(json) {
            if (json.Message == 0) {
                var defInfo = json.item.DictionaryUnits;
                defInfo.title = json.item.Caption;
                WorkFlowDef.$max = 9;

                //处理nodes 的 type
                $.each(defInfo.nodes, function (i, n) {
                    n.type = n.typeString;
                });

                console.log("流程图信息");
                console.log(defInfo);
                WorkFlowDef.loadData(defInfo);//流程图

                //节点网格
                var gridData = {
                    Message: 0,
                    item: {}
                };
                gridData.item.rows = json.item.ArrayUnits.Steps;
                gridData.item.total = gridData.item.rows.length;
                setGridRows(gridData, nodeGrid);
            }
            else {
                $.messager.alert(getErrorTitle(json.Message), "错误提示：<br />" + json.MessageDetail, 'error');
            }
        }

        function loadData() {
            //加载数据
            nodeGrid.datagrid("loading");
            $.getJSON("/api/WorkFlowDefinition/GetWorkFlowDefinitionById/@id", function (json) {
                setData(json);
            });
        }


        //数据明细网格定义

        var nodeGrid = $("#@(pageId)NodeGrid");

        nodeGrid.datagrid({
            fit: true,
            border: false,
            fitColumns: true,
            striped: true,
            pagination: false,
            rownumbers: true,
            singleSelect: true,
            idField: "Id",
            columns: [[
                {
                    field: 'name', title: '节点名称'
                },
                {
                    field: 'typeZHString', title: '节点类型'
                },
                {
                    field: 'Id', title: '节点ID'
                },
            ]],
            toolbar: [
                {
                    text: "刷新",
                    iconCls: "icon-reload",
                    handler: function () {
                        loadData();
                    }
                }
            ]
        });



        loadData();


        //jsondata = {
        //    title: "业务流程定义",
        //    nodes: {
        //        WorkFlowDef_node_1: { name: "node_1", left: 67, top: 69, type: "start", width: 24, height: 24 },
        //        WorkFlowDef_node_2: { name: "node_2", left: 219, top: 71, type: "task", width: 86, height: 24 },
        //        WorkFlowDef_node_5: { name: "node_5", left: 380, top: 71, type: "fork", width: 86, height: 24 }
        //    },
        //    lines: {
        //        WorkFlowDef_line_3: { type: "sl", from: "WorkFlowDef_node_1", to: "WorkFlowDef_node_2", name: "", marked: false },
        //        WorkFlowDef_line_6: { type: "sl", from: "WorkFlowDef_node_2", to: "WorkFlowDef_node_5", name: "", marked: false }
        //    },
        //    areas: {
        //        WorkFlowDef_area_8: { name: "area_8", left: 35, top: 39, color: "red", width: 472, height: 114 }
        //    }
        //};

    });
</script>

<div class="easyui-layout" data-options="fit:true">
    
    <div data-options="region:'center',border:false">
        <div id="@(pageId)tt" class="easyui-tabs" data-options="fit:true,border:false">
            <div title="流程图" id="@(pageId)WorkFlowDefBox" style="padding:0">
                <div id="@(pageId)WorkFlowDef"></div>
            </div>
            <div title="节点明细" data-options="" style="padding:0">
                <table id="@(pageId)NodeGrid"></table>
            </div>
        </div>  
    </div>
</div>




